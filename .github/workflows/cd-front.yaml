# .github/workflows/cd.yaml
# This workflow deploys a pre-built Docker image to Clever Cloud.

name: CD - Deploy Front to Clever Cloud

on:
  push:
    tags:
      - '*.*.*'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy'
        required: true
        type: choice
        options:
          - production
          - preprod
      image_tag:
        description: 'Docker image tag to deploy'
        required: true
        default: 'latest'
  workflow_run:
    workflows: ["Build and Push Front Container"]
    types:
      - completed
    branches:
      - main

jobs:
  deploy:
    name: Deploy to Clever Cloud
    runs-on: ubuntu-latest

    if: |
      github.event_name == 'push' ||
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success')

    permissions:
      contents: 'read'

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set deployment variables
        id: vars
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "environment=${{ inputs.environment }}" >> $GITHUB_OUTPUT
            echo "image_tag=${{ inputs.image_tag }}" >> $GITHUB_OUTPUT
          elif [ "${{ github.event_name }}" = "push" ]; then
            echo "environment=production" >> $GITHUB_OUTPUT
            echo "image_tag=${{ github.ref_name }}" >> $GITHUB_OUTPUT
          elif [ "${{ github.event_name }}" = "workflow_run" ]; then
            echo "environment=preprod" >> $GITHUB_OUTPUT
            echo "image_tag=latest" >> $GITHUB_OUTPUT
          fi

      - name: Set Clever Cloud App ID
        id: app
        run: |
          if [ "${{ steps.vars.outputs.environment }}" = "production" ]; then
            echo "id=${{ secrets.CLEVERCLOUD_FRONT_APP_ID }}" >> $GITHUB_OUTPUT
            echo "url=${{ secrets.CLEVERCLOUD_BASE_URL }}" >> $GITHUB_OUTPUT
          else
            echo "id=${{ secrets.CLEVERCLOUD_FRONT_APP_ID_PP }}" >> $GITHUB_OUTPUT
            echo "url=${{ secrets.CLEVERCLOUD_BASE_URL_PP }}" >> $GITHUB_OUTPUT
          fi

      - name: Install Clever Tools
        run: npm install -g clever-tools

      - name: Configure Clever Cloud for monorepo
        env:
          CLEVER_TOKEN: ${{ secrets.CLEVERCLOUD_TOKEN }}
          CLEVER_SECRET: ${{ secrets.CLEVERCLOUD_SECRET }}
          CLEVER_APP_ID: ${{ steps.app.outputs.id }}
          CLEVERCLOUD_BASE_URL: ${{ steps.app.outputs.url }}
          CC_DOCKER_LOGIN_PASSWORD: ${{ secrets.CC_DOCKER_LOGIN_PASSWORD }}
          CC_DOCKER_LOGIN_USERNAME: ${{ secrets.CC_DOCKER_LOGIN_USERNAME }}
        run: |
          clever env set APP_FOLDER "front" --app $CLEVER_APP_ID
          clever env set CC_DOCKERFILE "Dockerfile.deploy" --app $CLEVER_APP_ID
          clever env set CC_DOCKER_EXPOSED_HTTP_PORT "8080" --app $CLEVER_APP_ID
          clever env set CC_DOCKER_LOGIN_PASSWORD "$CC_DOCKER_LOGIN_PASSWORD" --app $CLEVER_APP_ID
          clever env set CC_DOCKER_LOGIN_USERNAME "$CC_DOCKER_LOGIN_USERNAME" --app $CLEVER_APP_ID
          clever env set CC_DOCKER_LOGIN_SERVER "ghcr.io" --app $CLEVER_APP_ID
          clever env set NUXT_PUBLIC_API_BASE_URL "$CLEVERCLOUD_BASE_URL" --app $CLEVER_APP_ID

      - name: Set image tag for deployment
        env:
          CLEVER_TOKEN: ${{ secrets.CLEVERCLOUD_TOKEN }}
          CLEVER_SECRET: ${{ secrets.CLEVERCLOUD_SECRET }}
          CLEVER_APP_ID: ${{ steps.app.outputs.id }}
        run: |
          clever env set TAG_VERSION "${{ steps.vars.outputs.image_tag }}" --app $CLEVER_APP_ID

      - name: Link and Deploy to Clever Cloud
        env:
          CLEVER_TOKEN: ${{ secrets.CLEVERCLOUD_TOKEN }}
          CLEVER_SECRET: ${{ secrets.CLEVERCLOUD_SECRET }}
          CLEVER_APP_ID: ${{ steps.app.outputs.id }}
        run: |
          clever link $CLEVER_APP_ID
          clever deploy --force --verbose

      - name: Notify Slack
        uses: slackapi/slack-github-action@v2.1.1
        if: steps.vars.outputs.environment == 'production'
        with:
          webhook: ${{ secrets.SLACK_WEBHOOK_URL }}
          webhook-type: incoming-webhook
          payload: |
            text: "Front deployment in production to Clever Cloud completed :rocket:"
            blocks:
              - type: "section"
                text:
                  type: "mrkdwn"
                  text: "*Front deployment in production to Clever Cloud completed* :rocket:"
